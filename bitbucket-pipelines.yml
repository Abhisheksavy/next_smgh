image: node:20

pipelines:
  branches:
    main:
      - step:
          name: Build Next.js App
          caches:
            - node
          script:
            - echo "ğŸ”§ Installing dependencies..."
            - npm ci
            - echo "ğŸŒ Setting environment variables..."
            - export NEXT_PUBLIC_APP_BASE_URL="http://134.209.131.20/backend/api/v1"
            - echo "ğŸ—ï¸ Building Next.js app (ISR enabled)..."
            - npm run build
            - rm -rf .next/cache
            - echo "ğŸ“¦ Preparing build artifacts..."
            - mkdir -p build-artifacts
            # Copy only what's needed for runtime
            - cp -r .next package.json next.config.* public build-artifacts/
            - echo "âœ… Build artifacts ready."

          artifacts:
            - build-artifacts/**

      - step:
          name: Deploy to Production
          deployment: production
          script:
            - echo "ğŸš€ Uploading optimized build to production server..."
            # Optional: clean old build (comment if you want to keep previous versions)
            - ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER "rm -rf /var/www/html/*"
            - scp -o StrictHostKeyChecking=no -r build-artifacts/* $SSH_USER@$SERVER:/var/www/html/
            - echo "ğŸ–¥ï¸ Running post-deploy tasks on server..."
            - ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER "
                set -e
                cd /var/www/html
                echo 'â†’ Installing production dependencies...'
                npm ci --omit=dev
                echo 'â†’ Restarting Next.js app via PM2...'
                pm2 reload all || pm2 start npm --name 'next-app' -- start
                pm2 save
                echo 'âœ… Deployment complete. App is live with ISR support.'
              "
