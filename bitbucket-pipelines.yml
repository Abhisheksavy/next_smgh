image: node:20

pipelines:
  branches:
    main:
      - step:
          name: Build Next.js App
          caches:
            - node
          script:
            - echo "ðŸ”§ Installing dependencies..."
            - npm ci
            - echo "ðŸŒ Setting environment variables..."
            - export NEXT_PUBLIC_APP_BASE_URL="http://134.209.131.20/backend/api/v1"
            - echo "ðŸ—ï¸ Building Next.js app (ISR enabled)..."
            - npm run build
            - rm -rf .next/cache
            - echo "ðŸ“¦ Packaging build..."
            - mkdir -p deploy
            - cp -r .next public package.json package-lock.json next.config.* deploy/
            - cd deploy && tar -czf ../build-artifacts.tar.gz . && cd ..
            - ls -lh build-artifacts.tar.gz
            - echo "âœ… Build archive created."

          artifacts:
            - build-artifacts.tar.gz

      - step:
          name: Deploy to Production
          deployment: production
          script:
            - echo "ðŸš€ Uploading build archive to server..."
            - scp -o StrictHostKeyChecking=no build-artifacts.tar.gz $SSH_USER@$SERVER:/var/www/html/build-artifacts.tar.gz
            - echo "ðŸ–¥ï¸ Deploying on server..."
            - |
              ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER '
                set -e
                cd /var/www/html
                echo "ðŸ§¹ Cleaning old files except /admin..."
                shopt -s extglob
                mkdir -p temp_deploy
                mv admin temp_deploy/ 2>/dev/null || true
                rm -rf !(temp_deploy|build-artifacts.tar.gz)
                mv temp_deploy/admin ./ 2>/dev/null || true
                rm -rf temp_deploy
                echo "ðŸ“¦ Extracting new build..."
                tar -xzf build-artifacts.tar.gz
                rm -f build-artifacts.tar.gz
                echo "ðŸ“¦ Installing production dependencies..."
                npm ci --omit=dev || npm install --omit=dev
                echo "ðŸš€ Restarting app via PM2..."
                pm2 delete next-app || true
                pm2 start node_modules/next/dist/bin/next --name next-app -- start -p 3000
                pm2 save
                echo "âœ… Deployment complete â€” ISR app live, /admin preserved."
              '
