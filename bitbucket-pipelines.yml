image: node:20

pipelines:
  branches:
    main:
      - step:
          name: Build Next.js App
          caches:
            - node
          script:
            - echo "ðŸš€ Starting build process..."
            - echo "Installing dependencies..."
            - npm ci
            - echo "Setting environment variables..."
            - export NEXT_PUBLIC_APP_BASE_URL="http://134.209.131.20/backend/api/v1"
            - echo "Building Next.js app..."
            - npm run build
            - rm -rf .next/cache
            - echo "âœ… Build complete."

          artifacts:
            - .next/**
            - package.json
            - next.config.*
            - public/**
            - ecosystem.config.js

      - step:
          name: Deploy to Production
          deployment: production
          script:
<<<<<<< Updated upstream
            - echo "Uploading build to server..."
            - scp -o StrictHostKeyChecking=no -r build-artifacts/* $SSH_USER@$SERVER:/var/www/html/
            - echo "Deploying build on server..."
            - ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER "
              set -e
              cd /var/www/html
              echo 'â†’ Installing production dependencies'
              npm ci --omit=dev
=======
            - echo "ðŸ“¦ Uploading app to production server..."
            - scp -o StrictHostKeyChecking=no -r ./* $SSH_USER@$SERVER:/var/www/html/
            - echo "ðŸ–¥ï¸ Running deploy commands on remote server..."
            - ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER "
              set -e
              cd /var/www/html
              echo 'â†’ Cleaning old cache'
              rm -rf .next/cache
              echo 'â†’ Installing production dependencies'
              npm ci --omit=dev
              echo 'â†’ Rebuilding app on server for correct OS binaries'
              npm run build
>>>>>>> Stashed changes
              echo 'â†’ Restarting with PM2'
              pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js
              pm2 save
              echo 'âœ… Deployment completed successfully!'
              "
