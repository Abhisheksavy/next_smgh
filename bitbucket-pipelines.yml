image: node:20

pipelines:
  branches:
    main:
      - step:
          name: Build Next.js App
          caches:
            - node
          script:
            - echo "Installing dependencies..."
            - npm ci
            - echo "Setting environment variables..."
            - export NEXT_PUBLIC_APP_BASE_URL=$NEXT_PUBLIC_APP_BASE_URL
            - echo "Building Next.js app..."
            - npm run build
            - echo "Preparing artifacts..."
            - mkdir build-artifacts
            - cp -r .next public next.config.js package.json build-artifacts/
          artifacts:
            - build-artifacts/**
      - step:
          name: Deploy to Production
          deployment: production
          script:
            - echo "Uploading build to server..."
            - scp -i $SSH_KEY_PATH -r build-artifacts/* $SERVER_USER@$SERVER_IP:/home/$SERVER_USER/
            - echo "Deploying build on server..."
            - ssh -i $SSH_KEY_PATH $SERVER_USER@$SERVER_IP "
                sudo cp -r /home/$SERVER_USER/.next /var/www/html/ &&
                sudo cp -r /home/$SERVER_USER/public /var/www/html/ &&
                sudo cp /home/$SERVER_USER/next.config.js /home/$SERVER_USER/package.json /var/www/html/ &&
                cd /var/www/html &&
                pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js &&
                pm2 save
              "