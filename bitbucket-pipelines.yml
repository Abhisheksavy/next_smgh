image: node:20

pipelines:
  branches:
    main:
      - step:
          name: Build & Deploy Next.js App
          caches:
            - node
          script:
            # 1. Inject environment variables
            - echo "Setting environment variables..."
            - echo "NEXT_PUBLIC_APP_BASE_URL=http://134.209.131.20/backend/api/v1" >> .env

            # 2. Install dependencies and build
            - npm ci
            - npm run build
            - rm -rf .next/cache

            # 3. Prepare deployment package
            - mkdir -p deployment
            - cp -r .next package.json package-lock.json next.config.js public .env deployment/ || true

            # 4. Create deploy script for EC2
            - |
              cat << 'EOF' > deployment/deploy.sh
              #!/bin/bash
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              if ! command -v npm &> /dev/null; then
                  echo "npm not found. Ensure NVM is installed."
                  exit 1
              fi
              if ! command -v pm2 &> /dev/null; then
                  npm install -g pm2
              fi
              npm ci --production
              pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
              echo "âœ… Deployment completed successfully!"
              EOF
              chmod +x deployment/deploy.sh

            # 5. Transfer files to EC2
            - pipe: atlassian/scp-deploy:0.3.4
              variables:
                USER: $SERVER_USER
                SERVER: $SERVER_IP
                LOCAL_PATH: "deployment/"
                REMOTE_PATH: "/var/www/html/"

            # 6. SSH into EC2 and run deploy script
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $SERVER_USER
                SERVER: $SERVER_IP
                MODE: "script"
                COMMAND: |
                  cd /var/www/html/
                  bash ./deploy.sh